networks:
  media_net:
    driver: bridge

services:
  pia:
    image: ghcr.io/thrnz/docker-wireguard-pia:latest
    container_name: pia
    cap_add: [ NET_ADMIN ]
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      - USER=${PIA_USER}
      - PASS=${PIA_PASS}
      - LOC=ca_ontario
      - PORT_FORWARDING=1
      - VPNDNS=1.1.1.1,9.9.9.9
      - ACTIVE_HEALTHCHECKS=1
      - LOCAL_NETWORK=192.168.0.0/16
    volumes:
      - ./pia:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - "8082:8082/tcp"
      - "6881:6881/tcp"
      - "6881:6881/udp"
      - "8080:8080/tcp"
    restart: unless-stopped
    networks: [ media_net ]

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:pia"
    depends_on: [ pia ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8082
    volumes:
      - ./configs/qbittorrent:/config
      - ${MEDIA_BASE}/downloads:/downloads
    restart: unless-stopped

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    network_mode: "service:pia"
    depends_on: [ pia ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./configs/sabnzbd:/config
      - ${MEDIA_BASE}/downloads:/downloads
      - ${MEDIA_BASE}/downloads/incomplete:/incomplete-downloads
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    ports: [ "9696:9696" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./configs/prowlarr:/config
    restart: unless-stopped
    networks: [ media_net ]

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    ports: [ "8989:8989" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./configs/sonarr:/config
      - ${MEDIA_BASE}/media:/data/media
      - ${MEDIA_BASE}/downloads:/downloads
    depends_on: [ prowlarr ]
    restart: unless-stopped
    networks: [ media_net ]

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    ports: [ "7878:7878" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./configs/radarr:/config
      - ${MEDIA_BASE}/media:/data/media
      - ${MEDIA_BASE}/downloads:/downloads
    depends_on: [ prowlarr ]
    restart: unless-stopped
    networks: [ media_net ]

  jellyseerr:
    image: fallenbagel/jellyseerr:develop
    container_name: jellyseerr
    ports: [ "5055:5055" ]
    environment:
      - TZ=${TZ}
    volumes:
      - ./configs/jellyseerr:/app/config
    depends_on: [ plex, sonarr, radarr ]
    restart: unless-stopped
    networks: [ media_net ]

  unmanic:
    image: josh5/unmanic:latest
    container_name: unmanic
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./configs/unmanic:/config
      - ${MEDIA_BASE}/media/movies:/library/movies
      - ${MEDIA_BASE}/media/tv:/library/tv
      - ${MEDIA_BASE}/downloads/complete:/library/watch
    ports:
      - 8888:8888
    networks: [ media_net ]
    restart: unless-stopped

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./configs/bazarr:/config
      - ${MEDIA_BASE}/media/movies:/movies
      - ${MEDIA_BASE}/media/tv:/tv
    ports:
      - 6767:6767
    networks: [ media_net ]
    restart: unless-stopped

  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    ports: [ "8181:8181" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ./configs/tautulli:/config
      # Mount Plex logs read-only so Tautulli can parse activity
      - ./configs/plex/Library Application Support/Plex Media Server/Logs:/logs:ro
    depends_on: [ plex ]
    restart: unless-stopped
    networks: [ media_net ]

  maintainerr:
    image: ghcr.io/jorenn92/maintainerr:main
    container_name: maintainerr
    # Optional: run as your media user for clean permissions
    user: "${PUID}:${PGID}"
    environment:
      - TZ=${TZ}
      # - UI_PORT=6246      # change only if 6246 conflicts
      # - API_PORT=3001     # change only if needed
      # - BASE_PATH=/maint  # only if reverse proxying at a subfolder
    volumes:
      - ./configs/maintainerr:/opt/data
    ports:
      - "6246:6246"
    restart: unless-stopped
    networks: [ media_net ]
  
  plex_watchlist_requester:
    image: randomnick/plex-watchlist-requester:latest
    container_name: plex_watchlist_requester
    environment:
      # - PLEX_USERNAME=${PLEX_USERNAME}
      # - PLEX_PASSWORD=${PLEX_PASSWORD}
      # OR instead of username/password, you can use:
      - PLEX_TOKEN=${PLEX_CLAIM} # get it from https://www.plex.tv/claim/
      - JELLYSEERR_API_KEY=${JELLYSEERR_API_KEY}
      - JELLYSEERR_URL=http://jellyseerr:5055
      - INCLUDE_USERS=true
      - REQUEST_TV=true
      - REQUEST_MOVIES=true
      - SKIP_EXISTING=true
      - CRON_SCHEDULE=*/5 * * * *  # run every 30 minutes
      - LOG_LEVEL=info
    networks: [ media_net ]
    restart: unless-stopped


  plex:
    image: lscr.io/linuxserver/plex:latest
    container_name: plex
    ports:
      - "32400:32400/tcp"
      - "1900:1900/udp"
      - "32469:32469/tcp"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - VERSION=docker
    volumes:
      - ./configs/plex:/config
      - ${MEDIA_BASE}/media:/data/media
      - ${MEDIA_BASE}/downloads:/data/downloads
    restart: unless-stopped
    networks: [ media_net ]

  # rolling_window:
  #   build: ./services/rolling-window
  #   container_name: rolling_window
  #   environment:
  #     - SONARR_URL=http://sonarr:8989
  #     - SONARR_API_KEY=${SONARR_API_KEY}
  #     - TAUTULLI_URL=http://tautulli:8181
  #     - TAUTULLI_API_KEY=${TAUTULLI_API_KEY}
  #     - FUTURE_WINDOW=4        # episodes ahead
  #     - RETAIN_DAYS=120        # keep watched for 120d
  #     - ROLLING_INTERVAL_HOURS=6
  #   restart: unless-stopped
  #   networks: [ media_net ]

