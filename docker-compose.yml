networks:
  media_net:
    driver: bridge

services:
  pia:
    image: ghcr.io/thrnz/docker-wireguard-pia:latest
    container_name: pia
    hostname: pia
    cap_add: [ NET_ADMIN ]
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      - USER=${PIA_USER}
      - PASS=${PIA_PASS}
      - LOC=ca_ontario
      - PORT_FORWARDING=1
      - VPNDNS=1.1.1.1,9.9.9.9
      - ACTIVE_HEALTHCHECKS=1
      - LOCAL_NETWORK=192.168.0.0/16
    volumes:
      - "${STACK_BASE}/pia:/pia-shared"
      - /lib/modules:/lib/modules:ro
    ports:
      - "0.0.0.0:8080:8090/tcp"  # SAB proxy
      - "0.0.0.0:8082:8091/tcp"  # Transmission proxy
      - "6881:6881/tcp"
      - "6881:6881/udp"
    restart: unless-stopped
    networks:
      - media_net
    healthcheck:
      test: ["CMD-SHELL", "ping -c1 google.com || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3

  transmission:
    image: lscr.io/linuxserver/transmission:latest
    container_name: transmission
    network_mode: container:pia
    depends_on: [ pia ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - TRANSMISSION_DOWNLOAD_DIR=/downloads/complete
      - TRANSMISSION_INCOMPLETE_DIR=/downloads/incomplete
      - TRANSMISSION_INCOMPLETE_DIR_ENABLED=true
      - TRANSMISSION_WATCH_DIR=/downloads/watch
      - TRANSMISSION_WATCH_DIR_ENABLED=true
      - TRANSMISSION_PEER_PORT=51413
      - TRANSMISSION_PEER_PORT_RANDOM_ON_START=false
      - TRANSMISSION_RATIO_LIMIT=5
      - TRANSMISSION_RATIO_LIMIT_ENABLED=true
      - TRANSMISSION_RPC_USERNAME=${TRANSMISSION_USER}
      - TRANSMISSION_RPC_PASSWORD=${TRANSMISSION_PASS}
      - TRANSMISSION_RPC_AUTHENTICATION_REQUIRED=true
      - TRANSMISSION_RPC_WHITELIST_ENABLED=false
      - TRANSMISSION_UMASK=002
    volumes:
      - "${CONFIG_BASE}/transmission:/config"
      - "${STACK_BASE}/pia:/pia-shared:ro"
      - ${MEDIA_BASE}:/media
      - "${MEDIA_BASE}/complete:/downloads/complete"
      - "${MEDIA_BASE_EXT}/incomplete:/downloads/incomplete"
      - "${MEDIA_BASE}/watch:/downloads/watch"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:9091 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3

  transmission-proxy:
    image: nginx:alpine
    container_name: transmission-proxy
    network_mode: service:pia
    depends_on: [ transmission ]
    restart: unless-stopped
    command: >
      sh -c "echo '
      events {}
      http {
        server {
          listen 8091;
          location / {
            proxy_pass http://127.0.0.1:9091;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
          }
        }
      }' > /etc/nginx/nginx.conf &&
      nginx -t &&
      exec nginx -g 'daemon off;'"

  transmission-gateway:
    image: nginx:alpine
    container_name: transmission-gateway
    hostname: transmission-gateway
    depends_on: [ transmission-proxy ]
    networks: [ media_net ]
    restart: unless-stopped
    command: >
      sh -c "echo '
      events {}
      http {
        server {
          listen 8091;
          location / {
            proxy_pass http://pia:8091;
          }
        }
      }' > /etc/nginx/nginx.conf &&
      nginx -t &&
      exec nginx -g 'daemon off;'"

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    network_mode: container:pia
    depends_on: [ pia ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - SABNZBD_OPTS=--server 0.0.0.0:8080 --https=0 --ipv6 0
      - PROWLARR_URL=http://prowlarr:9696
      - PROWLARR_API_KEY=${PROWLARR_API_KEY}
      - DISABLE_HOST_WHITELIST=1
    volumes:
      - "${CONFIG_BASE}/sabnzbd:/config"
      - "${CONFIG_BASE}/seedlink/scripts:/downloads/scripts:ro"
      - ${MEDIA_BASE}:/media
      - "${MEDIA_BASE}/complete:/downloads/complete"
      - "${MEDIA_BASE_EXT}/incomplete:/downloads/incomplete"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://127.0.0.1:8080 || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3

  sab-proxy:
    image: nginx:alpine
    container_name: sab-proxy
    network_mode: service:pia
    depends_on: [ sabnzbd ]
    restart: unless-stopped
    command: >
      sh -c "echo '
      events {}
      http {
        server {
          listen 8090;
          location / {
            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $$host;
            proxy_set_header X-Real-IP $$remote_addr;
          }
        }
      }' > /etc/nginx/nginx.conf &&
      nginx -t &&
      exec nginx -g 'daemon off;'"

  sab-gateway:
    image: nginx:alpine
    container_name: sab-gateway
    hostname: sab-gateway
    depends_on: [ sab-proxy ]
    networks: [ media_net ]
    restart: unless-stopped
    command: >
      sh -c "echo '
      events {}
      http {
        server {
          listen 8090;
          location / {
            proxy_pass http://pia:8090;
          }
        }
      }' > /etc/nginx/nginx.conf &&
      nginx -t &&
      exec nginx -g 'daemon off;'"

  cross-seed:
    image: ghcr.io/cross-seed/cross-seed:latest
    container_name: cross-seed
    hostname: cross-seed
    depends_on: [ transmission, prowlarr ]
    networks: [ media_net ]
    ports:
      - "2468:2468"
    environment:
      - CROSS_SEED_PROWLARR_URL=http://prowlarr:9696
      - CROSS_SEED_PROWLARR_API_KEY=${PROWLARR_API_KEY}
      - CROSS_SEED_TORRENT_CLIENT=transmission
      - CROSS_SEED_TORRENT_CLIENT_URL=http://transmission-gateway:8091
      - CROSS_SEED_DELAY=600
      - CROSS_SEED_MATCH_MODE=hash
      - CROSS_SEED_SAVE_DIR=/downloads/complete
    volumes:
      - "${MEDIA_BASE}/complete:/downloads/complete"
      - "${CONFIG_BASE}/cross-seed:/config"
    restart: unless-stopped

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    hostname: prowlarr
    ports: [ "9696:9696" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/prowlarr:/config"
    restart: unless-stopped
    networks: [ media_net ]

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    hostname: sonarr
    ports: [ "8989:8989" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/sonarr:/config"
      - ${MEDIA_BASE}:/media
      - "${MEDIA_BASE}/complete:/downloads/complete"
      - "${MEDIA_BASE_EXT}/incomplete:/downloads/incomplete"
    depends_on: [ prowlarr ]
    restart: unless-stopped
    networks: [ media_net ]

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    hostname: radarr
    ports: [ "7878:7878" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/radarr:/config"
      - ${MEDIA_BASE}:/media
      - "${MEDIA_BASE}/complete:/downloads/complete"
      - "${MEDIA_BASE_EXT}/incomplete:/downloads/incomplete"
    depends_on: [ prowlarr ]
    restart: unless-stopped
    networks: [ media_net ]

  unmanic:
    image: josh5/unmanic:latest
    container_name: unmanic
    hostname: unmanic
    runtime: nvidia
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UNMANIC_FFMPEG_ARGS=-analyzeduration 2147483647 -probesize 2147483647
    volumes:
      - "${CONFIG_BASE}/unmanic:/config"
      - "${MEDIA_BASE}/movies:/library/movies"
      - "${MEDIA_BASE}/tv:/library/tv"
      - "${MEDIA_BASE}/complete:/library/watch"
      - ${MEDIA_BASE}:/media
      - /dev/dri:/dev/dri
    ports:
      - 8888:8888
    networks: [ media_net ]
    restart: unless-stopped

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    hostname: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/bazarr:/config"
      - ${MEDIA_BASE}:/media
      - "${MEDIA_BASE}/movies:/movies"
      - "${MEDIA_BASE}/tv:/tv"
    ports:
      - 6767:6767
    networks: [ media_net ]
    restart: unless-stopped

  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    hostname: tautulli
    ports: [ "8181:8181" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/tautulli:/config"
      - "${CONFIG_BASE}/plex/Library Application Support/Plex Media Server/Logs:/logs:ro"
    restart: unless-stopped
    networks: [ media_net ]

  maintainerr:
    image: ghcr.io/jorenn92/maintainerr:main
    container_name: maintainerr
    hostname: maintainerr
    user: "${PUID}:${PGID}"
    environment:
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/maintainerr:/opt/data"
    ports:
      - "6246:6246"
    restart: unless-stopped
    networks: [ media_net ]

  cloudflare-ddns:
    image: oznu/cloudflare-ddns:latest
    container_name: cloudflare-ddns
    hostname: cloudflare-ddns
    restart: unless-stopped
    environment:
      - API_KEY=${CF_API_KEY}
      - ZONE=famflix.live
      - SUBDOMAIN=plex
      - PROXIED=false
      - TTL=120

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    hostname: cloudflared
    restart: unless-stopped
    command: tunnel run jellyseerr
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    networks: [ media_net ]