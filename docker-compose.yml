# -------------------------------------------------
# FamFlix Media Stack â€” NAS Deployment
# -------------------------------------------------
name: famflix

networks:
  media_net:
    driver: bridge

services:

  caddy:
    image: caddy:2.7
    container_name: caddy
    restart: unless-stopped
    ports:
      - "9000:80"
      - "4443:443"
    environment:
      - PLEX_HOST=10.175.1.111
    volumes:
      - "${STACK_BASE}/caddy/Caddyfile:/etc/caddy/Caddyfile:ro"
      - "${STACK_BASE}/caddy/data:/data"
      - "${STACK_BASE}/caddy/config:/config"
    networks:
      - media_net

  pia:
    image: ghcr.io/thrnz/docker-wireguard-pia:latest
    container_name: pia
    cap_add: [ NET_ADMIN ]
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    environment:
      - USER=${PIA_USER}
      - PASS=${PIA_PASS}
      - LOC=ca_ontario
      - PORT_FORWARDING=1
      - VPNDNS=1.1.1.1,9.9.9.9
      - ACTIVE_HEALTHCHECKS=1
      - LOCAL_NETWORK=192.168.0.0/16,172.17.0.0/16,172.18.0.0/16,172.19.0.0/16
    volumes:
      - "${STACK_BASE}/pia:/pia-shared"
      - /lib/modules:/lib/modules:ro
    ports:
      - "6881:6881/tcp"
      - "6881:6881/udp"
      - "8082:8082"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wg", "show", "interfaces"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - media_net

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    network_mode: "service:pia"
    depends_on: [ pia ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - WEBUI_PORT=8082
      - QBITTORRENT__BIND_ALL_INTERFACES=true
      - QBITTORRENT__WEBUI_HOST=0.0.0.0
    volumes:
      - "${CONFIG_BASE}/qbittorrent:/config"
      - "${STACK_BASE}/pia:/pia-shared:ro"
      - "${MEDIA_BASE}:/media"
      - "${DOWNLOAD_BASE}/complete:/downloads/complete"
      - "${DOWNLOAD_BASE}/incomplete:/downloads/incomplete"
    restart: unless-stopped
    # Note: network inherited from pia (network_mode)

  pia-port-sync:
    image: python:3.12-slim
    container_name: pia-port-sync
    depends_on:
      - pia
      - qbittorrent
    restart: unless-stopped
    networks:
      - media_net
    volumes:
      - "${STACK_BASE}/pia:/pia-shared:ro"
      - "${STACK_BASE}/scripts/pia-port-sync.sh:/pia-port-sync.sh:ro"
    environment:
      QBIT_HOST: "http://pia:8082"
      QBIT_USER: "${QBIT_USER}"
      QBIT_PASS: "${QBIT_PASS}"
      PIA_PORT_FILE: "/pia-shared/port.dat"
      SYNC_INTERVAL: "600"
    command: sh /pia-port-sync.sh

  cross-seed:
    image: ghcr.io/cross-seed/cross-seed:latest
    container_name: cross-seed
    restart: unless-stopped
    depends_on:
      - qbittorrent
    networks:
      - media_net
    command: daemon
    environment:
      - CROSS_SEED_LOG_LEVEL=info
      - CROSS_SEED_VERBOSE=true
      - TORRENT_CLIENT=qbittorrent
      - QBT_HOST=qbittorrent
      - QBT_PORT=8082
      - QBT_USERNAME=${QBIT_USER}
      - QBT_PASSWORD=${QBIT_PASS}
      - WATCH_DIR=/watch
      - OUTPUT_DIR=/torrents
      - SEARCH_INTERVAL=15m
      - INCLUDE_SINGLE=true
      - INCLUDE_NO_FOLDER=true
    volumes:
      - "${DOWNLOAD_BASE}/complete:/downloads"
      - "${STACK_BASE}/cross-seed:/config"
      - "${STACK_BASE}/cross-seed/torrents:/torrents"

  sabnzbd:
    image: lscr.io/linuxserver/sabnzbd:latest
    container_name: sabnzbd
    ports:
      - "8081:8081"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - SABNZBD__HOST=0.0.0.0
      - SABNZBD__INET_EXPOSURE=2
      - SABNZBD__PORT=8081
      - SABNZBD__HTTPS=0
      - DISABLE_HOST_WHITELIST=1
      - PROWLARR_URL=http://prowlarr:9696
      - PROWLARR_API_KEY=${PROWLARR_API_KEY}
      - TORRENTLEECH_UID=${TORRENTLEECH_UID}
      - TORRENTLEECH_PASS=${TORRENTLEECH_PASS}
      - MILKIE_COOKIE=${MILKIE_COOKIE}
      - MAX_PEERS=${MAX_PEERS}
      - STOP_RATIO=${STOP_RATIO}
      - SAB_COMPLETE_DIR=/downloads/complete
    volumes:
      - "${CONFIG_BASE}/sabnzbd:/config"
      - "${MEDIA_BASE}:/media"
      - "${SAB_DOWNLOAD_BASE}:/downloads"
    restart: unless-stopped
    networks:
      - media_net

  prowlarr:
    image: lscr.io/linuxserver/prowlarr:latest
    container_name: prowlarr
    ports: [ "9696:9696" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/prowlarr:/config"
    restart: unless-stopped
    networks:
      - media_net

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    ports: [ "8989:8989" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/sonarr:/config"
      - "${MEDIA_BASE}:/media"
      - "${DOWNLOAD_BASE}/complete:/downloads/complete"
      - "${DOWNLOAD_BASE}/incomplete:/downloads/incomplete"
      - "${SAB_DOWNLOAD_BASE}/complete:/downloads-sab/complete"
      - "${SAB_DOWNLOAD_BASE}/incomplete:/downloads-sab/incomplete"
    depends_on: [ prowlarr ]
    restart: unless-stopped
    networks:
      - media_net

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    ports: [ "7878:7878" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/radarr:/config"
      - "${MEDIA_BASE}:/media"
      - "${DOWNLOAD_BASE}/complete:/downloads/complete"
      - "${DOWNLOAD_BASE}/incomplete:/downloads/incomplete"
      - "${SAB_DOWNLOAD_BASE}/complete:/downloads-sab/complete"
      - "${SAB_DOWNLOAD_BASE}/incomplete:/downloads-sab/incomplete"
    depends_on: [ prowlarr ]
    restart: unless-stopped
    networks:
      - media_net

  arr-retry:
    image: python:3.12-slim
    container_name: arr-retry
    restart: unless-stopped
    entrypoint: ["python3", "-u", "/scripts/arr-retry.py"]
    environment:
      SONARR_URL: "http://sonarr:8989"
      RADARR_URL: "http://radarr:7878"
      SONARR_API_KEY: "${SONARR_API_KEY}"
      RADARR_API_KEY: "${RADARR_API_KEY}"
      LOOP_INTERVAL: "900"
      LOOKBACK_HOURS: "24"
    volumes:
      - "${STACK_BASE}/scripts/arr-retry.py:/scripts/arr-retry.py:ro"
      - "${STACK_BASE}/arr-retry:/state"
    networks:
      - media_net

  unmanic:
    image: josh5/unmanic:latest
    container_name: unmanic
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UNMANIC_TMP_DIR=/tmp/unmanic
    volumes:
      - "${CONFIG_BASE}/unmanic:/config"
      - "${STACK_BASE}/unmanic-temp:/tmp/unmanic"
      - "${MEDIA_BASE}/movies:/library/movies"
      - "${MEDIA_BASE}/tv:/library/tv"
      - "${MEDIA_BASE}/watch:/library/watch"
      - "${MEDIA_BASE}:/media"
      - "/dev/dri:/dev/dri"
    ports: [ "8888:8888" ]
    restart: unless-stopped
    networks:
      - media_net

  unmanic-watchdog:
    image: python:3.11-alpine
    container_name: unmanic-watchdog
    depends_on: [ unmanic, tautulli ]
    environment:
      - TAUTULLI_URL=http://tautulli:8181
      - TAUTULLI_API_KEY=${TAUTULLI_API_KEY}
      - CHECK_INTERVAL=5
      - COOLDOWN=30
    volumes:
      - "${STACK_BASE}/scripts/unmanic_watchdog.py:/scripts/unmanic_watchdog.py:ro"
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      [
        "sh", "-c",
        "pip install aiohttp docker && python /scripts/unmanic_watchdog.py"
      ]
    restart: unless-stopped
    networks:
      - media_net

  bazarr:
    image: lscr.io/linuxserver/bazarr:latest
    container_name: bazarr
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/bazarr:/config"
      - "${MEDIA_BASE}:/media"
      - "${MEDIA_BASE}/movies:/movies"
      - "${MEDIA_BASE}/tv:/tv"
    ports: [ "6767:6767" ]
    restart: unless-stopped
    networks:
      - media_net

  tautulli:
    image: lscr.io/linuxserver/tautulli:latest
    container_name: tautulli
    ports: [ "8181:8181" ]
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/tautulli:/config"
      - "${CONFIG_BASE}/plex/Library Application Support/Plex Media Server/Logs:/logs:ro"
    restart: unless-stopped
    networks:
      - media_net

  maintainerr:
    image: ghcr.io/jorenn92/maintainerr:main
    container_name: maintainerr
    user: "${PUID}:${PGID}"
    environment:
      - TZ=${TZ}
    volumes:
      - "${CONFIG_BASE}/maintainerr:/opt/data"
    ports: [ "6246:6246" ]
    restart: unless-stopped
    networks:
      - media_net

  cloudflare-ddns:
    image: oznu/cloudflare-ddns:latest
    container_name: cloudflare-ddns
    restart: unless-stopped
    environment:
      - API_KEY=${CF_API_KEY}
      - ZONE=famflix.live
      - SUBDOMAIN=plex
      - PROXIED=false
      - TTL=120
    networks:
      - media_net

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --config /config/config.yaml run
    environment:
      - TUNNEL_TOKEN=${CF_TUNNEL_TOKEN}
    volumes:
      - "${STACK_BASE}/cloudflared:/config"
    networks:
      - media_net
